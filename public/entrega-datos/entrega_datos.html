<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="entrega_datos.css">
    <title>Consulta</title>
</head>
<body><!-- MENU -->
    <nav>
        <img src="../../images/logo.png" class="logo">
        <ul>
            <li><a href="../consulta-datos/consulta_datos.html">Consulta Afiliado</a></li>
            <li><a href="../consulta-formula/consulta_formula.html">Verificar Formula</a></li>
            <li><a href="../ops/ops.html">Entrega de Datos</a></li>
            <li><a href="../entrega-datos/entrega_datos.html">Consulta OPS</a></li>
            <li><button id="logoutButton"><i class="fas fa-sign-out-alt"></i></button></li>
        </ul>
    </nav>
    <!-- -------------------------------------------------------------------------------- -->
    <!-- FORMULARIO -->
    <div class="container mt-1">
        <h1 class="text-center text-dark mb-4">Consulta OPS</h1>
        <div class="row justify-content-center">
            <div class="col-md-5">
                <form id="consultaForm">
                    <div class="form-group">
                        <label for="codPlan" class="form-inline-label">Código de Plan:</label>
                        <input type="text" id="codPlan" name="codPlan" class="form-control form-inline-input" required><br><br>
                    </div>
                    <div class="form-group">
                        <label for="codTipoIdAfiliado" class="form-inline-label">Tipo de ID Afiliado:</label>
                        <select id="codTipoIdAfiliado" name="codTipoIdAfiliado" class="form-control form-inline-input" required>
                            <option value="CC">CC</option>
                            <option value="AS">AS</option>
                            <option value="CE">CE</option>
                            <option value="CN">CN</option>
                            <option value="MS">MS</option>
                            <option value="NI">NI</option>
                            <option value="PA">PA</option>
                            <option value="PE">PE</option>
                            <option value="PT">PT</option>
                            <option value="RC">RC</option>
                            <option value="SC">SC</option>
                            <option value="TI">TI</option>
                        </select><br><br>
                    </div>
                    <div class="form-group">
                        <label for="numeroIdAfiliado" class="form-inline-label">Número de ID Afiliado:</label>
                        <input type="text" id="numeroIdAfiliado" name="numeroIdAfiliado" class="form-control form-inline-input" required><br><br>
                    </div>
                    <div class="form-group">
                        <label for="numeroOPS" class="form-inline-label">Número OPS:</label>
                        <input type="text" id="numeroOPS" name="numeroOPS" class="form-control form-inline-input" required><br><br>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="submit" class="btn btn-custom btn-block">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- <h2>Resultado de la Consulta</h2> -->
    <pre id="resultado"></pre>

    <script>
        document.getElementById('consultaForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const codPlan = document.getElementById('codPlan').value;
        const codTipoIdAfiliado = document.getElementById('codTipoIdAfiliado').value;
        const numeroIdAfiliado = document.getElementById('numeroIdAfiliado').value;
        const numeroOPS = document.getElementById('numeroOPS').value;

        const requestData = {
            codPlan,
            codTipoIdAfiliado,
            numeroIdAfiliado,
            numeroOPS
        };

        try {
            const response = await fetch('http://192.168.1.162:3000/api/rest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorText = await response.text(); // Obtener el error como texto crudo

                try {
                    // Intentar parsear el error como JSON
                    const errorData = JSON.parse(errorText);

                    // Asegurarse de que es un array y tiene al menos un objeto
                    if (Array.isArray(errorData) && errorData.length > 0) {
                        const errorInfo = errorData[0];
                        const codigoCausa = errorInfo.codigoCausaNoAutorizacion || 'Código no disponible';
                        const descripcion = errorInfo.descripcionCausaNoAutorizacion || 'Descripción no disponible';
                        
                        document.getElementById('resultado').innerHTML = `<div class="text-center m-0">Código: ${codigoCausa} <br> Mensaje: ${descripcion} </div>`;
                    } else {
                        document.getElementById('resultado').textContent = 'Error en la solicitud REST: Datos de error no válidos';
                    }
                } catch (parseError) {
                    // Si el error no es JSON, mostrarlo como texto
                    document.getElementById('resultado').textContent = 'Error en la solicitud REST: ' + errorText;
                }
            } else {
                const data = await response.json();
                document.getElementById('resultado').textContent = 'La solicitud fue exitosa: ' + JSON.stringify(data, null, 2);
            }

        } catch (error) {
            console.error("Error en la solicitud REST:", error);
            document.getElementById('resultado').textContent = 'Error en la solicitud REST: ' + error.message;
        }
    });
    </script>
</body>
</html>
